{% extends 'core/base.html' %}

{% block title %}My Products - Product Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-box me-2"></i>My Products</h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" onclick="openProductModal()">
                    <i class="fas fa-plus me-2"></i>Add Product
                </button>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <!-- <div class="col-md-3">
            <select class="form-select" id="categoryFilter" onchange="filterProducts()">
                <option value="">All Categories</option>
            </select>
        </div> -->
        <div class="col-md-3">
            <select class="form-select" id="statusFilter" onchange="filterProducts()">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
        <div class="col-md-4">
            <input type="text" class="form-control" id="searchInput" placeholder="Search products..." onkeyup="filterProducts()">
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                <i class="fas fa-times me-2"></i>Clear
            </button>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="row" id="products-container">
        <div class="col-12 text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productName" class="form-label">Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productName" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productCategory" class="form-label">Category <span class="text-danger">*</span></label>
                                <select class="form-select" id="productCategory" required>
                                    <option value="">Select Category</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productPrice" class="form-label">Price <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productPrice" step="0.01" min="0" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productStock" class="form-label">Stock</label>
                                <input type="number" class="form-control" id="productStock" min="0" value="0">
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label for="productVideo" class="form-label">Video (Max 20MB total)</label>
                        <input type="file" class="form-control" id="productVideo" accept="video/*">
                        <div class="form-text">Supported formats: MP4, AVI, MOV, WMV</div>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="progress-container">
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-center">
                            <small class="text-muted">Processing video...</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">
                    <span id="saveProductButtonText">Save Product</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Product Detail Modal -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productDetailContent">
                <!-- Product details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="addToCartBtn" onclick="addToCart()">
                    <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product? This action cannot be undone.</p>
                <p><strong id="deleteProductName"></strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteProduct()">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set active nav
    setActiveNav('my-products');

    let allProducts = [];
    let allCategories = [];
    let currentEditingId = null;
    let deleteProductId = null;
    let selectedProductForCart = null;

    // Load initial data
    async function loadInitialData() {
        try {
            // Load categories
            // const categoriesResponse = await apiCall('/core/categories/');
            // allCategories = categoriesResponse.data || [];
            
            // // Populate category filter and form select
            // populateCategoryOptions();
            
            // Load products
            await loadProducts();
            
        } catch (error) {
            console.error('Error loading initial data:', error);
        }
    }

    async function loadProducts() {
        try {
            const response = await apiCall('/core/my-products/');
            allProducts = response.data || [];
            displayProducts(allProducts);
        } catch (error) {
            console.error('Error loading products:', error);
            document.getElementById('products-container').innerHTML = 
                '<div class="col-12 text-center text-danger">Error loading products</div>';
        }
    }

    function populateCategoryOptions() {
        // Category filter
        const categoryFilter = document.getElementById('categoryFilter');
        categoryFilter.innerHTML = '<option value="">All Categories</option>' +
            allCategories.map(cat => `<option value="${cat.uuid}">${cat.name}</option>`).join('');
        
        // Product form category select
        const productCategory = document.getElementById('productCategory');
        productCategory.innerHTML = '<option value="">Select Category</option>' +
            allCategories.map(cat => `<option value="${cat.uuid}">${cat.name}</option>`).join('');
    }

    function displayProducts(products) {
        const container = document.getElementById('products-container');
        
        if (products.length === 0) {
            container.innerHTML = '<div class="col-12 text-center">No products found</div>';
            return;
        }
        
        container.innerHTML = products.map(product => {
            const canEdit = userRole === 'admin' || product.created_by === username;
            
            return `
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title">${product.name}</h5>
                                <span class="badge bg-${getStatusColor(product.status)}">
                                    ${product.status.charAt(0).toUpperCase() + product.status.slice(1)}
                                </span>
                            </div>
                            <p class="card-text text-muted small">${product.category?.name || 'No Category'}</p>
                            <p class="card-text">${product.description || 'No description'}</p>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong class="text-success">₹${parseFloat(product.price).toFixed(2)}</strong>
                                </div>
                                <div class="col-6 text-end">
                                    <small class="text-muted">Stock: ${product.stock || 0}</small>
                                </div>
                            </div>
                            ${product.video ? `
                                <div class="mb-3">
                                    <small class="text-info">
                                        <i class="fas fa-video me-1"></i>Has Video
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewProduct('${product.uuid}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                ${canEdit ? `
                                    <button class="btn btn-outline-secondary btn-sm" onclick="editProduct('${product.uuid}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteProduct('${product.uuid}', '${product.name}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function filterProducts() {
        const categoryFilter = document.getElementById('categoryFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        let filteredProducts = allProducts.filter(product => {
            const matchesCategory = !categoryFilter || product.category?.uuid === categoryFilter;
            const matchesStatus = !statusFilter || product.status === statusFilter;
            const matchesSearch = !searchTerm || 
                product.name.toLowerCase().includes(searchTerm) ||
                (product.description && product.description.toLowerCase().includes(searchTerm));
                
            return matchesCategory && matchesStatus && matchesSearch;
        });
        
        displayProducts(filteredProducts);
    }

    function clearFilters() {
        document.getElementById('categoryFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('searchInput').value = '';
        displayProducts(allProducts);
    }

    function openProductModal() {
        currentEditingId = null;
        document.getElementById('productModalTitle').textContent = 'Add Product';
        document.getElementById('saveProductButtonText').textContent = 'Save Product';
        document.getElementById('productForm').reset();
        clearValidationErrors();
        hideProgressBar();
    }

    async function editProduct(uuid) {
        try {
            const response = await apiCall(`/core/products/${uuid}/`);
            const product = response.data;
            
            currentEditingId = uuid;
            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.getElementById('saveProductButtonText').textContent = 'Update Product';
            
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category?.uuid || '';
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productStock').value = product.stock || 0;
            document.getElementById('productDescription').value = product.description || '';
            
            clearValidationErrors();
            hideProgressBar();
            
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
            
        } catch (error) {
            showToast('Error', 'Failed to load product details', 'danger');
        }
    }

    async function saveProduct() {
        clearValidationErrors();
        
        const name = document.getElementById('productName').value.trim();
        const category = document.getElementById('productCategory').value;
        const price = document.getElementById('productPrice').value;
        const stock = document.getElementById('productStock').value;
        const description = document.getElementById('productDescription').value.trim();
        const videoFile = document.getElementById('productVideo').files[0];
        
        // Validation
        if (!name) {
            showFieldError('productName', 'Name is required');
            return;
        }
        if (!category) {
            showFieldError('productCategory', 'Category is required');
            return;
        }
        if (!price || parseFloat(price) < 0) {
            showFieldError('productPrice', 'Valid price is required');
            return;
        }
        
        // Check video size (20MB limit)
        if (videoFile && videoFile.size > 20 * 1024 * 1024) {
            showFieldError('productVideo', 'Video size must be less than 20MB');
            return;
        }
        
        const formData = new FormData();
        formData.append('name', name);
        formData.append('category', category);
        formData.append('price', price);
        formData.append('stock', stock || 0);
        formData.append('description', description);
        
        if (videoFile) {
            formData.append('video', videoFile);
            showProgressBar();
        }
        
        try {
            if (currentEditingId) {
                await apiCall(`/core/products/${currentEditingId}/`, 'PATCH', formData, 'multipart/form-data');
                showToast('Success', 'Product updated successfully');
            } else {
                await apiCall('/core/products/', 'POST', formData, 'multipart/form-data');
                showToast('Success', 'Product created successfully');
            }
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            modal.hide();
            loadProducts();
            
        } catch (error) {
            showToast('Error', error.message, 'danger');
        } finally {
            hideProgressBar();
        }
    }

    async function viewProduct(uuid) {
        try {
            const response = await apiCall(`/core/products/${uuid}/`);
            const product = response.data;
            
            selectedProductForCart = product;
            
            const content = `
                <div class="row">
                    <div class="col-md-8">
                        <h4>${product.name}</h4>
                        <p class="text-muted">${product.category?.name || 'No Category'}</p>
                        <p>${product.description || 'No description available'}</p>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <strong>Price: <span class="text-success">$${parseFloat(product.price).toFixed(2)}</span></strong>
                            </div>
                            <div class="col-6">
                                <strong>Stock: ${product.stock || 0}</strong>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Status: </strong>
                            <span class="badge bg-${getStatusColor(product.status)}">
                                ${product.status.charAt(0).toUpperCase() + product.status.slice(1)}
                            </span>
                        </div>
                        
                        ${product.video ? `
                            <div class="mb-3">
                                <strong>Video:</strong>
                                <video controls class="w-100 mt-2" style="max-height: 300px;">
                                    <source src="${product.video}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                        ` : ''}
                        
                        <small class="text-muted">
                            Created: ${new Date(product.created_at).toLocaleString()}
                        </small>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h6>Add to Cart</h6>
                                <div class="mb-3">
                                    <label for="cartQuantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="cartQuantity" min="1" max="${product.stock || 1}" value="1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('productDetailContent').innerHTML = content;
            
            // Show/hide add to cart button based on stock and status
            const addToCartBtn = document.getElementById('addToCartBtn');
            if (product.status === 'approved' && (product.stock || 0) > 0) {
                addToCartBtn.style.display = 'block';
            } else {
                addToCartBtn.style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
            modal.show();
            
        } catch (error) {
            showToast('Error', 'Failed to load product details', 'danger');
        }
    }

    function deleteProduct(uuid, name) {
        deleteProductId = uuid;
        document.getElementById('deleteProductName').textContent = name;
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    async function confirmDeleteProduct() {
        if (!deleteProductId) return;
        
        try {
            await apiCall(`/core/products/${deleteProductId}/`, 'DELETE');
            showToast('Success', 'Product deleted successfully');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();
            loadProducts();
            
        } catch (error) {
            showToast('Error', error.message, 'danger');
        }
    }

    async function addToCart() {
        if (!selectedProductForCart) return;
        
        const quantity = parseInt(document.getElementById('cartQuantity').value);
        
        if (quantity <= 0 || quantity > (selectedProductForCart.stock || 0)) {
            showToast('Error', 'Invalid quantity', 'danger');
            return;
        }
        
        // Get or create cart from localStorage
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        // Check if product already in cart
        const existingItem = cart.find(item => item.product_uuid === selectedProductForCart.uuid);
        
        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            cart.push({
                product_uuid: selectedProductForCart.uuid,
                product_name: selectedProductForCart.name,
                product_price: selectedProductForCart.price,
                quantity: quantity
            });
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
        
        showToast('Success', 'Product added to cart');
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('productDetailModal'));
        modal.hide();
    }

    function showProgressBar() {
        document.querySelector('.progress-container').style.display = 'block';
        // Simulate progress
        let progress = 0;
        const interval = setInterval(() => {
            progress += 10;
            document.querySelector('.progress-bar').style.width = progress + '%';
            if (progress >= 100) {
                clearInterval(interval);
            }
        }, 200);
    }

    function hideProgressBar() {
        document.querySelector('.progress-container').style.display = 'none';
        document.querySelector('.progress-bar').style.width = '0%';
    }

    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const feedback = field.nextElementSibling;
        
        field.classList.add('is-invalid');
        feedback.textContent = message;
    }

    function clearValidationErrors() {
        document.querySelectorAll('.is-invalid').forEach(field => {
            field.classList.remove('is-invalid');
        });
        document.querySelectorAll('.invalid-feedback').forEach(feedback => {
            feedback.textContent = '';
        });
    }

    function getStatusColor(status) {
        const colors = {
            'pending': 'warning',
            'approved': 'success',
            'rejected': 'danger',
            'cancelled': 'secondary'
        };
        return colors[status] || 'secondary';
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', loadInitialData);
</script>
{% endblock %}