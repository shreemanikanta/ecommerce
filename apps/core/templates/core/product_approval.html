{% extends 'core/base.html' %}

{% block title %}Product Approval - Product Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-check-circle me-2"></i>Product Approval
            </h1>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="statusTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                        <i class="fas fa-clock me-2"></i>Pending <span class="badge bg-warning ms-2" id="pending-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button" role="tab">
                        <i class="fas fa-check me-2"></i>Approved <span class="badge bg-success ms-2" id="approved-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab">
                        <i class="fas fa-times me-2"></i>Rejected <span class="badge bg-danger ms-2" id="rejected-count">0</span>
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="statusTabsContent">
        <!-- Pending Products -->
        <div class="tab-pane fade show active" id="pending" role="tabpanel">
            <div class="row" id="pending-products">
                <div class="col-12 text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Approved Products -->
        <div class="tab-pane fade" id="approved" role="tabpanel">
            <div class="row" id="approved-products">
                <div class="col-12 text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rejected Products -->
        <div class="tab-pane fade" id="rejected" role="tabpanel">
            <div class="row" id="rejected-products">
                <div class="col-12 text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Detail Modal -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Product Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="product-detail-content">
                <!-- Product details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div id="approval-buttons" style="display: none;">
                    <button type="button" class="btn btn-danger me-2" onclick="updateProductStatus('reject')">
                        <i class="fas fa-times me-2"></i>Reject
                    </button>
                    <button type="button" class="btn btn-success" onclick="updateProductStatus('approve')">
                        <i class="fas fa-check me-2"></i>Approve
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Action Modal -->
<div class="modal fade" id="bulkActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to <strong id="bulk-action-text"></strong> the selected products?</p>
                <p>Selected items: <span id="bulk-count">0</span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmBulkAction()">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set active nav
    setActiveNav('product-approval');

    let allProducts = [];
    let currentProductForReview = null;
    let selectedProductIds = new Set();
    let currentBulkAction = null;

    // Load all products
    async function loadProducts() {
        try {
            const response = await apiCall('/core/products/');
            allProducts = response.data || [];
            
            // Group products by status
            const pendingProducts = allProducts.filter(p => p.status === 'pending');
            const approvedProducts = allProducts.filter(p => p.status === 'approved');
            const rejectedProducts = allProducts.filter(p => p.status === 'rejected');
            
            // Update counts
            document.getElementById('pending-count').textContent = pendingProducts.length;
            document.getElementById('approved-count').textContent = approvedProducts.length;
            document.getElementById('rejected-count').textContent = rejectedProducts.length;
            
            // Display products in respective tabs
            displayProducts('pending', pendingProducts);
            displayProducts('approved', approvedProducts);
            displayProducts('rejected', rejectedProducts);
            
        } catch (error) {
            console.error('Error loading products:', error);
        }
    }

    function displayProducts(status, products) {
        const container = document.getElementById(`${status}-products`);
        
        if (products.length === 0) {
            container.innerHTML = `<div class="col-12 text-center text-muted">No ${status} products found</div>`;
            return;
        }
        
        const showBulkActions = status === 'pending';
        
        let html = '';
        
        if (showBulkActions) {
            html += `
                <div class="col-12 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAll-${status}" onchange="toggleSelectAll('${status}')">
                                        <label class="form-check-label" for="selectAll-${status}">
                                            Select All
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button class="btn btn-sm btn-success me-2" onclick="bulkAction('approve')" disabled id="bulk-approve-btn">
                                        <i class="fas fa-check me-2"></i>Bulk Approve
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="bulkAction('reject')" disabled id="bulk-reject-btn">
                                        <i class="fas fa-times me-2"></i>Bulk Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += products.map(product => {
            const canApprove = status === 'pending' && (userRole === 'admin' || userRole === 'staff');
            
            return `
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        ${showBulkActions ? `
                            <div class="card-header">
                                <div class="form-check">
                                    <input class="form-check-input product-checkbox" type="checkbox" value="${product.uuid}" onchange="updateBulkButtons()">
                                    <label class="form-check-label">Select</label>
                                </div>
                            </div>
                        ` : ''}
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title">${product.name}</h5>
                                <span class="badge bg-${getStatusColor(product.status)}">
                                    ${product.status.charAt(0).toUpperCase() + product.status.slice(1)}
                                </span>
                            </div>
                            <p class="card-text text-muted small">${product.category?.name || 'No Category'}</p>
                            <p class="card-text">${(product.description || 'No description').substring(0, 100)}${product.description && product.description.length > 100 ? '...' : ''}</p>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong class="text-success">$${parseFloat(product.price).toFixed(2)}</strong>
                                </div>
                                <div class="col-6 text-end">
                                    <small class="text-muted">Stock: ${product.stock || 0}</small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">
                                    <i class="fas fa-user me-1"></i>By: ${product.created_by_name || 'Unknown'}
                                </small>
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>${new Date(product.created_at).toLocaleString()}
                                </small>
                            </div>
                            ${product.video ? `
                                <div class="mb-3">
                                    <small class="text-info">
                                        <i class="fas fa-video me-1"></i>Has Video
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="reviewProduct('${product.uuid}')">
                                    <i class="fas fa-eye me-2"></i>Review Product
                                </button>
                                ${canApprove ? `
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-success btn-sm" onclick="quickApproval('${product.uuid}', 'approve')">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="quickApproval('${product.uuid}', 'reject')">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    }

    // Review product in detail
    async function reviewProduct(productUuid) {
        try {
            const response = await apiCall(`/core/products/${productUuid}/`);
            const product = response.data;
            
            currentProductForReview = product;
            
            const content = `
                <div class="row">
                    <div class="col-md-8">
                        <h4>${product.name}</h4>
                        <p class="text-muted mb-3">${product.category?.name || 'No Category'}</p>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>Product Information</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Price:</strong></td>
                                        <td class="text-success">$${parseFloat(product.price).toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Stock:</strong></td>
                                        <td>${product.stock || 0}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Status:</strong></td>
                                        <td>
                                            <span class="badge bg-${getStatusColor(product.status)}">
                                                ${product.status.charAt(0).toUpperCase() + product.status.slice(1)}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Created by:</strong></td>
                                        <td>${product.created_by_name || 'Unknown'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Date:</strong></td>
                                        <td>${new Date(product.created_at).toLocaleString()}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>Description</h6>
                                <p>${product.description || 'No description provided'}</p>
                            </div>
                        </div>
                        
                        ${product.video ? `
                            <div class="mb-4">
                                <h6>Product Video</h6>
                                <video controls class="w-100" style="max-height: 400px;">
                                    <source src="${product.video}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                        ` : ''}
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Review Actions</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="reviewAction" id="approveRadio" value="approve">
                                        <label class="form-check-label text-success" for="approveRadio">
                                            <i class="fas fa-check me-2"></i>Approve Product
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="reviewAction" id="rejectRadio" value="reject">
                                        <label class="form-check-label text-danger" for="rejectRadio">
                                            <i class="fas fa-times me-2"></i>Reject Product
                                        </label>
                                    </div>
                                </div>
                                <hr>
                                <div class="mb-3">
                                    <label for="reviewNotes" class="form-label">Review Notes (Optional)</label>
                                    <textarea class="form-control" id="reviewNotes" rows="3" placeholder="Add any notes about your decision..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('product-detail-content').innerHTML = content;
            
            // Show approval buttons if product is pending
            if (product.status === 'pending' && (userRole === 'admin' || userRole === 'staff')) {
                document.getElementById('approval-buttons').style.display = 'block';
            } else {
                document.getElementById('approval-buttons').style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('productDetailModal'));
            modal.show();
            
        } catch (error) {
            showToast('Error', 'Failed to load product details', 'danger');
        }
    }

    // Update product status from detail modal
    async function updateProductStatus(action) {
        if (!currentProductForReview) return;
        
        // Get selected action from radio buttons
        const selectedAction = document.querySelector('input[name="reviewAction"]:checked')?.value || action;
        const notes = document.getElementById('reviewNotes')?.value || '';
        
        try {
            await apiCall(`/core/products/${currentProductForReview.uuid}/approval/`, 'POST', {
                action: selectedAction
            });
            
            showToast('Success', `Product ${selectedAction}d successfully`);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('productDetailModal'));
            modal.hide();
            
            loadProducts();
            
        } catch (error) {
            showToast('Error', error.message, 'danger');
        }
    }

    // Quick approval without opening modal
    async function quickApproval(productUuid, action) {
        try {
            await apiCall(`/core/products/${productUuid}/status/`, 'POST', {
                action: action
            });
            
            showToast('Success', `Product ${action}d successfully`);
            loadProducts();
            
        } catch (error) {
            showToast('Error', error.message, 'danger');
        }
    }

    // Toggle select all checkbox
    function toggleSelectAll(status) {
        const selectAllCheckbox = document.getElementById(`selectAll-${status}`);
        const productCheckboxes = document.querySelectorAll(`#${status}-products .product-checkbox`);
        
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
            if (selectAllCheckbox.checked) {
                selectedProductIds.add(checkbox.value);
            } else {
                selectedProductIds.delete(checkbox.value);
            }
        });
        
        updateBulkButtons();
    }

    // Update bulk action buttons state
    function updateBulkButtons() {
        const checkboxes = document.querySelectorAll('.product-checkbox:checked');
        const approveBtn = document.getElementById('bulk-approve-btn');
        const rejectBtn = document.getElementById('bulk-reject-btn');
        
        // Update selected IDs
        selectedProductIds.clear();
        checkboxes.forEach(checkbox => {
            selectedProductIds.add(checkbox.value);
        });
        
        const hasSelection = selectedProductIds.size > 0;
        
        if (approveBtn) approveBtn.disabled = !hasSelection;
        if (rejectBtn) rejectBtn.disabled = !hasSelection;
    }

    // Bulk action
    function bulkAction(action) {
        if (selectedProductIds.size === 0) {
            showToast('Error', 'Please select at least one product', 'danger');
            return;
        }
        
        currentBulkAction = action;
        document.getElementById('bulk-action-text').textContent = action;
        document.getElementById('bulk-count').textContent = selectedProductIds.size;
        
        const modal = new bootstrap.Modal(document.getElementById('bulkActionModal'));
        modal.show();
    }

    // Confirm bulk action
    async function confirmBulkAction() {
        if (!currentBulkAction || selectedProductIds.size === 0) return;
        
        try {
            const promises = Array.from(selectedProductIds).map(productId =>
                apiCall(`/core/products/${productId}/approval/`, 'POST', {
                    action: currentBulkAction
                })
            );
            
            await Promise.all(promises);
            
            showToast('Success', `${selectedProductIds.size} products ${currentBulkAction}d successfully`);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('bulkActionModal'));
            modal.hide();
            
            // Clear selections
            selectedProductIds.clear();
            document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('[id^="selectAll-"]').forEach(cb => cb.checked = false);
            
            loadProducts();
            
        } catch (error) {
            showToast('Error', 'Some products failed to update', 'danger');
        }
    }

    function getStatusColor(status) {
        const colors = {
            'pending': 'warning',
            'approved': 'success',
            'rejected': 'danger',
            'cancelled': 'secondary'
        };
        return colors[status] || 'secondary';
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', loadProducts);

    // Add event listeners for tab changes
    document.addEventListener('DOMContentLoaded', function() {
        const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
        tabs.forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(e) {
                // Clear selections when switching tabs
                selectedProductIds.clear();
                updateBulkButtons();
            });
        });
    });
</script>
{% endblock %}