{% extends 'core/base.html' %}

{% block title %}Categories - Product Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-tags me-2"></i>Categories</h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoryModal" onclick="openCategoryModal()">
                    <i class="fas fa-plus me-2"></i>Add Category
                </button>
            </div>
        </div>
    </div>

    <!-- Categories Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">All Categories</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Products Count</th>
                                    <th>Created Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categories-table">
                                <tr>
                                    <td colspan="5" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalTitle">Add Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="categoryName" required>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                        <div class="invalid-feedback"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCategory()">
                    <span id="saveButtonText">Save Category</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this category? This action cannot be undone.</p>
                <p><strong id="deleteItemName"></strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set active nav
    setActiveNav('categories');

    let currentEditingId = null;
    let deleteItemId = null;

    // Load categories
    async function loadCategories() {
        try {
            const response = await apiCall('/core/categories/');
            const categories = response.data || [];
            
            const tbody = document.getElementById('categories-table');
            if (categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No categories found</td></tr>';
                return;
            }
            
            // Get products count for each category
            const productsResponse = await apiCall('/api/products/');
            const products = productsResponse.data || [];
            
            tbody.innerHTML = categories.map(category => {
                const productCount = products.filter(p => p.category?.uuid === category.uuid).length;
                
                return `
                    <tr>
                        <td>
                            <strong>${category.name}</strong>
                        </td>
                        <td>${category.description || 'No description'}</td>
                        <td>
                            <span class="badge bg-info">${productCount}</span>
                        </td>
                        <td>${new Date(category.created_at).toLocaleDateString()}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="editCategory('${category.uuid}', '${category.name}', '${category.description || ''}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${category.uuid}', '${category.name}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
        } catch (error) {
            console.error('Error loading categories:', error);
            document.getElementById('categories-table').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">Error loading categories</td></tr>';
        }
    }

    function openCategoryModal(isEdit = false) {
        currentEditingId = null;
        document.getElementById('categoryModalTitle').textContent = 'Add Category';
        document.getElementById('saveButtonText').textContent = 'Save Category';
        document.getElementById('categoryForm').reset();
        clearValidationErrors();
    }

    function editCategory(uuid, name, description) {
        currentEditingId = uuid;
        document.getElementById('categoryModalTitle').textContent = 'Edit Category';
        document.getElementById('saveButtonText').textContent = 'Update Category';
        document.getElementById('categoryName').value = name;
        document.getElementById('categoryDescription').value = description;
        clearValidationErrors();
        
        const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
        modal.show();
    }

    async function saveCategory() {
        clearValidationErrors();
        
        const name = document.getElementById('categoryName').value.trim();
        const description = document.getElementById('categoryDescription').value.trim();
        
        if (!name) {
            showFieldError('categoryName', 'Name is required');
            return;
        }
        
        const data = { name, description };
        
        try {
            if (currentEditingId) {
                await apiCall(`/api/categories/${currentEditingId}/`, 'PATCH', data);
                showToast('Success', 'Category updated successfully');
            } else {
                await apiCall('/api/categories/', 'POST', data);
                showToast('Success', 'Category created successfully');
            }
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('categoryModal'));
            modal.hide();
            loadCategories();
            
        } catch (error) {
            if (error.message.includes('Validation failed')) {
                // Handle validation errors
                handleValidationErrors(error);
            } else {
                showToast('Error', error.message, 'danger');
            }
        }
    }

    function deleteCategory(uuid, name) {
        deleteItemId = uuid;
        document.getElementById('deleteItemName').textContent = name;
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    async function confirmDelete() {
        if (!deleteItemId) return;
        
        try {
            await apiCall(`/core/categories/${deleteItemId}/`, 'DELETE');
            showToast('Success', 'Category deleted successfully');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();
            loadCategories();
            
        } catch (error) {
            showToast('Error', error.message, 'danger');
        }
    }

    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const feedback = field.nextElementSibling;
        
        field.classList.add('is-invalid');
        feedback.textContent = message;
    }

    function clearValidationErrors() {
        document.querySelectorAll('.is-invalid').forEach(field => {
            field.classList.remove('is-invalid');
        });
        document.querySelectorAll('.invalid-feedback').forEach(feedback => {
            feedback.textContent = '';
        });
    }

    function handleValidationErrors(error) {
        // This would handle server-side validation errors
        // Implement based on your API error response format
        if (error.data) {
            Object.keys(error.data).forEach(field => {
                if (field === 'name') {
                    showFieldError('categoryName', error.data[field][0]);
                } else if (field === 'description') {
                    showFieldError('categoryDescription', error.data[field][0]);
                }
            });
        }
    }

    // Load categories when page loads
    document.addEventListener('DOMContentLoaded', loadCategories);
</script>
{% endblock %}