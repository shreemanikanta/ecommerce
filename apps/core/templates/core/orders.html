{% extends 'core/base.html' %}

{% block title %}Orders - Product Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-shopping-cart me-2"></i>Orders</h1>
                <div>
                    <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#cartModal" onclick="loadCart()">
                        <i class="fas fa-shopping-basket me-2"></i>View Cart
                        <span class="badge bg-danger ms-1" id="cart-count">0</span>
                    </button>
                    <button class="btn btn-primary" onclick="createOrderFromCart()">
                        <i class="fas fa-plus me-2"></i>Place Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders List -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Your Orders</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Items</th>
                                    <th>Total Amount</th>
                                    <th>Order Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table">
                                <tr>
                                    <td colspan="5" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cart Modal -->
<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Shopping Cart</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="cart-items">
                    <!-- Cart items will be loaded here -->
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <strong>Total: $<span id="cart-total">0.00</span></strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" onclick="clearCart()">
                    <i class="fas fa-trash me-2"></i>Clear Cart
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continue Shopping</button>
                <button type="button" class="btn btn-primary" onclick="placeOrderFromCart()">
                    <i class="fas fa-check me-2"></i>Place Order
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Order Detail Modal -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="order-detail-content">
                <!-- Order details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Order Modal -->
<div class="modal fade" id="createOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createOrderForm">
                    <div class="mb-3">
                        <label class="form-label">Select Products</label>
                        <div id="available-products">
                            <!-- Available products will be loaded here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createOrder()">
                    <i class="fas fa-plus me-2"></i>Create Order
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set active nav
    setActiveNav('orders');

    let availableProducts = [];

    // Load orders and update cart count
    async function loadOrders() {
        try {
            const response = await apiCall('/orders/');
            const orders = response.data || [];
            
            const tbody = document.getElementById('orders-table');
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => {
                const totalAmount = order.items.reduce((sum, item) => 
                    sum + (parseFloat(item.price_at_order) * item.quantity), 0);
                
                return `
                    <tr>
                        <td>
                            <strong>#${order.uuid.slice(0, 8)}</strong>
                        </td>
                        <td>
                            <span class="badge bg-info">${order.items.length} item(s)</span>
                        </td>
                        <td>
                            <strong class="text-success">${totalAmount.toFixed(2)}</strong>
                        </td>
                        <td>${new Date(order.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${order.uuid}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
        } catch (error) {
            console.error('Error loading orders:', error);
            document.getElementById('orders-table').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">Error loading orders</td></tr>';
        }
    }

    // Load available products for order creation
    async function loadAvailableProducts() {
        try {
            const response = await apiCall('/core/products/');
            availableProducts = (response.data || []).filter(product => 
                product.status === 'approved' && (product.stock || 0) > 0
            );
        } catch (error) {
            console.error('Error loading products:', error);
        }
    }

    // Update cart count in navbar
    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('cart-count').textContent = count;
    }

    // Load cart modal
    function loadCart() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalElement = document.getElementById('cart-total');
        
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<p class="text-center text-muted">Your cart is empty</p>';
            cartTotalElement.textContent = '0.00';
            return;
        }
        
        let total = 0;
        cartItemsContainer.innerHTML = cart.map((item, index) => {
            const itemTotal = parseFloat(item.product_price) * item.quantity;
            total += itemTotal;
            
            return `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="card-title mb-1">${item.product_name}</h6>
                                <small class="text-muted">${parseFloat(item.product_price).toFixed(2)} each</small>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="updateCartQuantity(${index}, -1)">-</button>
                                    <input type="text" class="form-control text-center" value="${item.quantity}" readonly>
                                    <button class="btn btn-outline-secondary" onclick="updateCartQuantity(${index}, 1)">+</button>
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                <strong>${itemTotal.toFixed(2)}</strong>
                            </div>
                            <div class="col-md-1 text-end">
                                <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        cartTotalElement.textContent = total.toFixed(2);
    }

    // Update cart item quantity
    function updateCartQuantity(index, change) {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        if (cart[index]) {
            cart[index].quantity += change;
            
            if (cart[index].quantity <= 0) {
                cart.splice(index, 1);
            }
            
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
            updateCartCount();
        }
    }

    // Remove item from cart
    function removeFromCart(index) {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        loadCart();
        updateCartCount();
        showToast('Success', 'Item removed from cart');
    }

    // Clear entire cart
    function clearCart() {
        localStorage.removeItem('cart');
        loadCart();
        updateCartCount();
        showToast('Success', 'Cart cleared');
    }

    // Place order from cart
    async function placeOrderFromCart() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        if (cart.length === 0) {
            showToast('Error', 'Cart is empty', 'danger');
            return;
        }
        
        const orderData = {
            items: cart.map(item => ({
                product_uuid: item.product_uuid,
                quantity: item.quantity
            }))
        };
        
        try {
            await apiCall('/orders/create/', 'POST', orderData);
            showToast('Success', 'Order placed successfully');
            
            // Clear cart and close modal
            localStorage.removeItem('cart');
            updateCartCount();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('cartModal'));
            modal.hide();
            
            // Reload orders
            loadOrders();
            
        } catch (error) {
            showToast('Error', error.message, 'danger');
        }
    }

    // Create order from cart button (alternative method)
    async function createOrderFromCart() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        if (cart.length > 0) {
            // If cart has items, place order directly
            await placeOrderFromCart();
        } else {
            // If cart is empty, show create order modal
            await loadAvailableProducts();
            showCreateOrderModal();
        }
    }

    // Show create order modal
    function showCreateOrderModal() {
        const container = document.getElementById('available-products');
        
        if (availableProducts.length === 0) {
            container.innerHTML = '<p class="text-center text-muted">No products available for order</p>';
        } else {
            container.innerHTML = availableProducts.map(product => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="card-title mb-1">${product.name}</h6>
                                <small class="text-muted">${product.category?.name || 'No Category'}</small>
                                <br>
                                <small class="text-success">${parseFloat(product.price).toFixed(2)} • Stock: ${product.stock}</small>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">Qty</span>
                                    <input type="number" class="form-control" id="qty-${product.uuid}" min="0" max="${product.stock}" value="0">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="select-${product.uuid}" onchange="toggleProductQuantity('${product.uuid}')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        const modal = new bootstrap.Modal(document.getElementById('createOrderModal'));
        modal.show();
    }

    // Toggle product selection
    function toggleProductQuantity(productUuid) {
        const checkbox = document.getElementById(`select-${productUuid}`);
        const quantityInput = document.getElementById(`qty-${productUuid}`);
        
        if (checkbox.checked) {
            quantityInput.value = 1;
            quantityInput.disabled = false;
        } else {
            quantityInput.value = 0;
            quantityInput.disabled = true;
        }
    }

    // Create order from form
    async function createOrder() {
        const selectedItems = [];
        
        availableProducts.forEach(product => {
            const checkbox = document.getElementById(`select-${product.uuid}`);
            const quantity = parseInt(document.getElementById(`qty-${product.uuid}`).value);
            
            if (checkbox.checked && quantity > 0) {
                selectedItems.push({
                    product_uuid: product.uuid,
                    quantity: quantity
                });
            }
        });
        
        if (selectedItems.length === 0) {
            showToast('Error', 'Please select at least one product', 'danger');
            return;
        }
        
        const orderData = { items: selectedItems };
        
        try {
            await apiCall('/orders/', 'POST', orderData);
            showToast('Success', 'Order created successfully');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('createOrderModal'));
            modal.hide();
            
            loadOrders();
            
        } catch (error) {
            showToast('Error', error.message, 'danger');
        }
    }

    // View order details
    async function viewOrderDetails(orderUuid) {
        try {
            const response = await apiCall(`/orders/${orderUuid}/`);
            const order = response.data;
            
            const totalAmount = order.items.reduce((sum, item) => 
                sum + (parseFloat(item.price_at_order) * item.quantity), 0);
            
            const content = `
                <div class="row">
                    <div class="col-12">
                        <h5>Order #${order.uuid.slice(0, 8)}</h5>
                        <p class="text-muted">Placed on: ${new Date(order.created_at).toLocaleString()}</p>
                        <hr>
                        
                        <h6>Items Ordered:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${order.items.map(item => `
                                        <tr>
                                            <td>${item.product.name}</td>
                                            <td>${parseFloat(item.price_at_order).toFixed(2)}</td>
                                            <td>${item.quantity}</td>
                                            <td>${(parseFloat(item.price_at_order) * item.quantity).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr class="table-dark">
                                        <th colspan="3">Total Amount</th>
                                        <th>${totalAmount.toFixed(2)}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('order-detail-content').innerHTML = content;
            
            const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            modal.show();
            
        } catch (error) {
            showToast('Error', 'Failed to load order details', 'danger');
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        loadOrders();
        loadAvailableProducts();
        updateCartCount();
    });
</script>
{% endblock %}